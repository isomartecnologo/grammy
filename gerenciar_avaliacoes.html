<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Avalia√ß√µes - Gerente</title>
  <style>
    :root {
      --bg: linear-gradient(135deg, #264491, #1a2d64);
      --card: rgba(255, 255, 255, 0.07);
      --gold: gold;
    }
    body {
      background: var(--bg);
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      padding: 40px 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      color: var(--gold);
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    .welcome {
      text-align: center;
      color: #ccc;
      margin: 20px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      padding: 14px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    th {
      background: rgba(0, 191, 255, 0.3);
      color: var(--gold);
    }
    tr:hover { background: rgba(255, 255, 255, 0.05); }
    .btn-danger {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
    }
    .btn-voltar {
      display: inline-block;
      background: #666;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      margin-bottom: 20px;
    }
    .resultado { padding: 15px; background: rgba(46, 204, 113, 0.2); border-radius: 8px; text-align: center; }
    .error { padding: 15px; background: rgba(231, 76, 60, 0.2); border-radius: 8px; text-align: center; color: #e74c3c; }
  </style>
</head>
<body>

  <div class="container">
    <h1>üóëÔ∏è Gerenciar Todas as Avalia√ß√µes</h1>
    <p class="welcome">Bem-vindo, gerente <strong id="nomeGerente">Carregando...</strong></p>

    <a href="gerente.html" class="btn-voltar">‚Üê Voltar ao Painel</a>

    <div id="mensagem"></div>

    <table id="tabelaAvaliacoes">
      <thead>
        <tr>
          <th>Jurado</th>
          <th>V√≠deo</th>
          <th>M√©dia</th>
          <th>Data</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="5" style="text-align:center;">Carregando...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const usuarioAtual = JSON.parse(localStorage.getItem("usuarioAtual"));

    if (!usuarioAtual || usuarioAtual.tipo !== "gerente") {
      alert("Acesso restrito a gerentes.");
      window.location.href = "index.html";
    }

    document.getElementById("nomeGerente").textContent = usuarioAtual.nome;

    async function carregarAvaliacoes() {
      try {
        const res = await fetch('/grammy/api.php?acao=listar_avaliacoes');
        const avaliacoes = await res.json();

        const tbody = document.querySelector("#tabelaAvaliacoes tbody");
        tbody.innerHTML = '';

        if (avaliacoes.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhuma avalia√ß√£o realizada.</td></tr>`;
          return;
        }

        avaliacoes.forEach(av => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${av.jurado_nome}</td>
            <td>${av.apresentacao_titulo}</td>
            <td><strong>${av.media}</strong></td>
            <td>${new Date(av.data_avaliacao).toLocaleString()}</td>
            <td>
              <button class="btn-danger" onclick='excluir(${av.apresentacao_id}, "${av.jurado_nome}")'>üóëÔ∏è Excluir</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        document.getElementById("mensagem").innerHTML = 
          `<div class="error">Erro ao carregar avalia√ß√µes.</div>`;
      }
    }

    async function excluir(apresentacao_id, jurado_nome) {
      if (!confirm(`Excluir avalia√ß√£o do jurado "${jurado_nome}"?`)) return;

      const formData = new FormData();
      formData.append('apresentacao_id', apresentacao_id);
      formData.append('jurado_nome', jurado_nome);

      try {
        const res = await fetch('/grammy/api.php?acao=excluir_avaliacao', {
          method: 'POST',
          body: formData
        });

        const result = await res.json();

        if (result.sucesso) {
          document.getElementById("mensagem").innerHTML = 
            `<div class="resultado">‚úÖ Avalia√ß√£o exclu√≠da!</div>`;
          setTimeout(carregarAvaliacoes, 1500);
        } else {
          throw new Error(result.erro);
        }
      } catch (err) {
        document.getElementById("mensagem").innerHTML = 
          `<div class="error">‚ùå Erro: ${err.message}</div>`;
      }
    }

    window.addEventListener('DOMContentLoaded', carregarAvaliacoes);
  </script>
</body>
</html>