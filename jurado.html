<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Jurado - Grammy 2025</title>
  <style>
    :root {
      --bg-primary: linear-gradient(135deg, #0c1a3e, #1a2d64);
      --bg-secondary: rgba(10, 15, 50, 0.9);
      --text-color: #fff;
      --input-bg: rgba(255, 255, 255, 0.1);
      --input-border: rgba(255, 255, 255, 0.2);
      --btn-gradient: linear-gradient(90deg, #00bfff, #0088cc);
      --gold: gold;
      --glow: rgba(255, 215, 0, 0.8);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      pointer-events: none;
      z-index: -1;
    }

    body {
      background: var(--bg-primary);
      min-height: 100vh;
      color: white;
    }

    .container {
      width: 90%;
      max-width: 1000px;
      background: var(--bg-secondary);
      border: 3px solid var(--gold);
      border-radius: 20px;
      box-shadow: 0 0 30px var(--glow);
      padding: 40px 20px;
      margin: 30px auto;
    }

    h1, h2, h3 {
      text-align: center;
      color: var(--gold);
      text-shadow: 0 0 15px var(--glow);
    }

    .welcome {
      text-align: center;
      font-size: 1.3rem;
      margin: 20px 0;
      color: #ccc;
    }

    .form-group {
      margin: 20px 0;
    }

    .form-group label {
      display: block;
      color: white;
      margin-bottom: 8px;
    }

    select.form-control, input.form-control {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--input-bg);
      color: white;
    }
	
	select.form-control2, input.form-control2 {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--input-border);
      border-radius: 8px;
      background: var(--input-bg);
      color: green;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
    }

    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    th {
      background: rgba(0, 191, 255, 0.3);
      color: var(--gold);
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }

    .btn-primary {
      background: var(--btn-gradient);
      color: white;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .resultado {
      margin: 20px 0;
      padding: 15px;
      background: rgba(46, 204, 113, 0.2);
      border: 1px solid #27ae60;
      border-radius: 8px;
      color: #27ae60;
      text-align: center;
    }

    .error {
      color: #e74c3c;
      text-align: center;
    }

    .info-box {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid var(--gold);
    }

    /* Minhas avalia√ß√µes */
    .minhas-avaliacoes {
      margin-top: 40px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    .avaliacao-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      margin-bottom: 8px;
      border-radius: 6px;
    }

    .avaliacao-info {
      font-weight: bold;
    }
	
	.botao {
      display: inline-block;
      padding: 10px 20px;
      font-size: 16px;
      color: white;
      background-color: #007bff;
      text-decoration: none;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
	
	/* Bot√£o centralizado abaixo */
    .botao-centralizado {
      display: block;
      margin: 20px auto 0;
      text-align: center;
      width: fit-content;
    }
	
  </style>
</head>
<body>

  <div class="container">
    <h1>üìù Avalia√ß√£o de V√≠deos</h1>
    <p class="welcome">Bem-vindo, jurado <strong id="nomeJurado">Carregando...</strong></p>

    <button onclick="sair()" class="btn btn-danger">üö™ Sair</button>

    <!-- Sele√ß√£o de apresenta√ß√£o -->
    <div class="form-group">
      <label for="videoSelect">Selecione a apresenta√ß√£o para avaliar:</label>
      <select id="videoSelect" class="form-control2">
        <option value="">Selecione uma apresenta√ß√£o</option>
      </select>
    </div>

    <!-- Informa√ß√µes da apresenta√ß√£o -->
    <div id="infoApresentacao" style="display:none;">
      <div class="info-box">
        <h3 id="tituloVideo"></h3>
        <p><strong>Criador:</strong> <span id="criadorVideo"></span></p>
        <p><strong>Link:</strong> <a id="linkDrive" href="#" target="_blank" style="color:#00bfff;">Acessar Pasta no Google Drive</a></p>
      </div>
    </div>

    <!-- Tabela de notas -->
    <table id="tabelaNotas" style="display:none;">
      <thead>
        <tr>
          <th>Categoria</th>
          <th>Nota (0.0 a 10.0)</th>
        </tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>

    <!-- Bot√£o de salvar/excluir -->
    <div style="text-align:center; margin: 30px 0;">
      <button id="btnSalvar" class="btn btn-primary">üíæ Salvar Avalia√ß√£o</button>
      <button id="btnExcluir" class="btn btn-danger" style="display:none;">üóëÔ∏è Excluir Avalia√ß√£o</button>
    </div>

    <!-- Resultado -->
    <div id="resultado" style="display:none;"></div>

    <!-- Lista de avalia√ß√µes j√° feitas -->
    <div class="minhas-avaliacoes">
      <h3>‚úÖ Minhas Avalia√ß√µes</h3>
      <div id="listaAvaliacoesSalvas">
        <p>Carregando suas avalia√ß√µes...</p>
      </div>
    </div>
  </div>

  <script>
    let usuarioAtual = null;
    let apresentacoes = [];
    let avaliacoesJurado = [];

    // Carregar dados ao iniciar
    window.addEventListener('DOMContentLoaded', async () => {
      const stored = localStorage.getItem("usuarioAtual");
      if (!stored) {
        alert("Voc√™ precisa estar logado.");
        window.location.href = "index.html";
        return;
      }

      try {
        usuarioAtual = JSON.parse(stored);
        document.getElementById("nomeJurado").textContent = usuarioAtual.nome;

        await carregarDados();
      } catch (err) {
        console.error("Erro ao carregar usu√°rio:", err);
        alert("Sess√£o inv√°lida.");
        window.location.href = "index.html";
      }
    });

    async function carregarDados() {
      try {
        const res1 = await fetch('/grammy/api.php?acao=listar_apresentacoes');
        apresentacoes = await res1.json();

        const res2 = await fetch('/grammy/api.php?acao=listar_avaliacoes');
        const todasAvaliacoes = await res2.json();

        // Filtra avalia√ß√µes do jurado logado
        avaliacoesJurado = todasAvaliacoes.filter(av => av.jurado_nome === usuarioAtual.nome);

        // Atualiza UI
        atualizarListaApresentacoes();
        exibirMinhasAvaliacoes();
        resetarFormulario(); // Garante que comece vazio
      } catch (err) {
        console.error("Erro ao carregar dados:", err);
        mostrarResultado("Erro ao carregar dados.", false);
      }
    }

    function atualizarListaApresentacoes() {
      const select = document.getElementById("videoSelect");
      // Mant√©m apenas a op√ß√£o inicial
      select.innerHTML = '<option value="">Selecione uma apresenta√ß√£o</option>';

      const pendentes = apresentacoes.filter(pasta =>
        !avaliacoesJurado.some(av => av.apresentacao_id == pasta.id)
      );

      pendentes.forEach(pasta => {
        const opt = document.createElement("option");
        opt.value = pasta.id;
        opt.textContent = pasta.titulo;
        select.appendChild(opt);
      });
    }

    function resetarFormulario() {
      document.getElementById("infoApresentacao").style.display = "none";
      document.getElementById("tabelaNotas").style.display = "none";
      document.getElementById("btnExcluir").style.display = "none";
      document.getElementById("btnSalvar").textContent = "üíæ Salvar Avalia√ß√£o";
      document.getElementById("resultado").style.display = "none";
    }

    function mostrarResultado(mensagem, sucesso) {
      const el = document.getElementById("resultado");
      el.textContent = mensagem;
      el.className = sucesso ? "resultado" : "error";
      el.style.display = "block";
    }

    // Quando o jurado seleciona uma apresenta√ß√£o
    document.getElementById("videoSelect").addEventListener("change", function () {
      const id = this.value;
      if (!id) {
        resetarFormulario();
        return;
      }

      const pasta = apresentacoes.find(p => p.id == id);
      if (!pasta) return;

      // Exibe informa√ß√µes da apresenta√ß√£o
      document.getElementById("tituloVideo").textContent = pasta.titulo;
      document.getElementById("criadorVideo").textContent = pasta.criador;
      document.getElementById("linkDrive").href = pasta.url;
      document.getElementById("infoApresentacao").style.display = "block";

      // Preenche a tabela de notas
      preencherTabelaNotas();

      // Verifica se j√° foi avaliada
      const avaliacaoExistente = avaliacoesJurado.find(av => av.apresentacao_id == id);

      if (avaliacaoExistente) {
        preencherNotasNaTabela(avaliacaoExistente);
        document.getElementById("btnSalvar").textContent = "üîÑ Atualizar Avalia√ß√£o";
        document.getElementById("btnExcluir").style.display = "inline-block";
      } else {
        limparNotasNaTabela();
        document.getElementById("btnSalvar").textContent = "üíæ Salvar Avalia√ß√£o";
        document.getElementById("btnExcluir").style.display = "none";
      }

      document.getElementById("tabelaNotas").style.display = "table";
    });

    function preencherTabelaNotas() {
      const tabela = document.getElementById("tabela");
      tabela.innerHTML = "";

      const categorias = [
        "Roteiro", "Produ√ß√£o", "Equipe de lipsinch/dublagem/karaok√™", "Figurino",
        "Sinergia m√∫sica/filmagem", "Criatividade", "Coreografia/performance",
        "Artistas-revela√ß√£o (elenco/atua√ß√£o)", "Caracteriza√ß√£o de arte audiovisual"
      ];

      categorias.forEach(cat => {
        const tr = document.createElement("tr");
        const tdCat = document.createElement("td");
        tdCat.textContent = cat;
        tr.appendChild(tdCat);

        const tdNota = document.createElement("td");
        const select = document.createElement("select");

        for (let n = 0; n <= 10; n += 0.5) {
          const opt = document.createElement("option");
          opt.value = n.toFixed(1);
          opt.textContent = n.toFixed(1);
          select.appendChild(opt);
        }

        tdNota.appendChild(select);
        tr.appendChild(tdNota);
        tabela.appendChild(tr);
      });
    }

    function preencherNotasNaTabela(avaliacao) {
      const selects = document.querySelectorAll("#tabela select");
      const notasMap = {
        "Roteiro": avaliacao.roteiro,
        "Produ√ß√£o": avaliacao.producao,
        "Equipe de lipsinch/dublagem/karaok√™": avaliacao.lipsync,
        "Figurino": avaliacao.figurino,
        "Sinergia m√∫sica/filmagem": avaliacao.sinergia,
        "Criatividade": avaliacao.criatividade,
        "Coreografia/performance": avaliacao.performance,
        "Artistas-revela√ß√£o (elenco/atua√ß√£o)": avaliacao.revelacao,
        "Caracteriza√ß√£o de arte audiovisual": avaliacao.arte_audiovisual
      };

      selects.forEach(sel => {
        const cat = sel.parentElement.parentElement.querySelector("td").textContent;
        const valor = notasMap[cat];
        if (valor !== undefined) {
          sel.value = valor.toFixed(1);
        }
      });
    }

    function limparNotasNaTabela() {
      const selects = document.querySelectorAll("#tabela select");
      selects.forEach(sel => { sel.selectedIndex = 0; });
    }

    async function salvarAvaliacao() {
      const id = document.getElementById("videoSelect").value;
      if (!id) return alert("Selecione uma apresenta√ß√£o.");

      const selects = document.querySelectorAll("#tabela select");
      let soma = 0;
      const notas = {};

      for (const sel of selects) {
        const valor = parseFloat(sel.value);
        if (isNaN(valor)) return alert("Preencha todas as notas.");
        soma += valor;
        const cat = sel.parentElement.parentElement.querySelector("td").textContent;
        notas[cat] = valor;
      }

      const media = (soma / selects.length).toFixed(2);

      const response = await fetch('/grammy/api.php?acao=salvar_avaliacao', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: parseInt(id),
          jurado: usuarioAtual.nome,
          notas: notas
        })
      });

      const result = await response.json();

      if (result.sucesso) {
        mostrarResultado(`‚úÖ ${result.sucesso} M√©dia: ${media}`, true);
        setTimeout(async () => {
          await carregarDados();
          resetarFormulario();
        }, 1500);
      } else {
        mostrarResultado(`‚ùå Erro: ${result.erro}`, false);
      }
    }
/*
    async function excluirAvaliacao() {
      const id = document.getElementById("videoSelect").value;
      if (!id || !confirm("Tem certeza que deseja excluir sua avalia√ß√£o?")) return;

      const response = await fetch('api.php?acao=excluir_avaliacao', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          apresentacao_id: parseInt(id),
          jurado_nome: usuarioAtual.nome
        })
      });

      const result = await response.json();

      if (result.sucesso) {
        mostrarResultado(result.sucesso, true);
        setTimeout(async () => {
          await carregarDados();
          resetarFormulario();
        }, 1500);
      } else {
        mostrarResultado(`‚ùå Erro: ${result.erro}`, false);
      }
    }

*/
/*
//Adicionado 18-10 00h
async function excluirAvaliacao() {
  const id = document.getElementById("videoSelect").value;
  if (!id) return alert("Nenhuma apresenta√ß√£o selecionada.");

  if (!confirm("Tem certeza que deseja excluir sua avalia√ß√£o?")) return;

  try {
    const response = await fetch('api.php?acao=excluir_avaliacao', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        apresentacao_id: parseInt(id),
        jurado_nome: usuarioAtual.nome
      })
    });

    const result = await response.json();

    if (result.sucesso) {
      mostrarResultado(result.mensagem || "‚úÖ Avalia√ß√£o exclu√≠da!", true);
      setTimeout(async () => {
        await carregarDados(); // Recarrega tudo
        resetarFormulario();
      }, 1500);
    } else {
      throw new Error(result.erro || "Falha desconhecida");
    }
  } catch (err) {
    console.error("Erro ao excluir:", err);
    mostrarResultado(`‚ùå Erro: ${err.message}`, false);
  }
}

// Fun√ß√£o para excluir pelo bot√£o na lista
async function excluirAvaliacaoPorItem(apresentacao_id) {
  if (!confirm("Deseja excluir esta avalia√ß√£o?")) return;
  
  // Simula sele√ß√£o no select
  document.getElementById("videoSelect").value = apresentacao_id;
  await excluirAvaliacao();
}
//Termina aqui
*/
async function excluirAvaliacao() {
  console.log("‚úÖ Fun√ß√£o excluirAvaliacao foi chamada");

  const id = document.getElementById("videoSelect").value;
  if (!id) {
    console.log("‚ùå Nenhuma apresenta√ß√£o selecionada");
    alert("Selecione uma apresenta√ß√£o.");
    return;
  }

  if (!confirm("Tem certeza que deseja excluir sua avalia√ß√£o?")) return;

  // Verifica se o usu√°rio est√° logado
  if (!usuarioAtual || !usuarioAtual.nome) {
    console.log("‚ùå Usu√°rio n√£o autenticado", usuarioAtual);
    alert("Voc√™ precisa estar logado.");
    window.location.href = "index.html";
    return;
  }

  try {
    console.log("üì§ Enviando exclus√£o:", {
      apresentacao_id: parseInt(id),
      jurado_nome: usuarioAtual.nome
    });

    const response = await fetch('/grammy/api.php?acao=excluir_avaliacao', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        apresentacao_id: parseInt(id),
        jurado_nome: usuarioAtual.nome
      })
    });

    console.log("üì® Resposta recebida:", response.status);

    const result = await response.json();
    console.log("üìä Resultado:", result);

    if (result.sucesso) {
      mostrarResultado(result.mensagem || "‚úÖ Exclu√≠do!", true);
      setTimeout(async () => {
        await carregarDados();
        resetarFormulario();
      }, 1500);
    } else {
      mostrarResultado(`‚ùå ${result.erro}`, false);
    }
  } catch (err) {
    console.error("‚ùå ERRO NA REQUISI√á√ÉO:", err);
    mostrarResultado(`Falha: ${err.message}`, false);
  }
}

// Fun√ß√£o para excluir diretamente pelo ID (sem depender do select)

async function excluirAvaliacaoPorItem(apresentacao_id) {
  if (!confirm("Tem certeza que deseja excluir sua avalia√ß√£o?")) return;

  try {
    const formData = new FormData();
    formData.append('apresentacao_id', apresentacao_id);
    formData.append('jurado_nome', usuarioAtual.nome);

    const response = await fetch('/grammy/api.php?acao=excluir_avaliacao', {
      method: 'POST',
      body: formData  // Sem headers (o navegador define automaticamente com boundary)
    });

    const result = await response.json();

    if (result.sucesso) {
      mostrarResultado("‚úÖ Avalia√ß√£o exclu√≠da com sucesso!", true);
      setTimeout(async () => {
        await carregarDados();   // Atualiza apresenta√ß√µes e avalia√ß√µes
        resetarFormulario();
      }, 1500);
    } else {
      throw new Error(result.erro || "Falha desconhecida");
    }
  } catch (err) {
    console.error("Erro ao excluir avalia√ß√£o:", err);
    mostrarResultado(`‚ùå Erro: ${err.message}`, false);
  }
}

//Termina aqui

	function exibirMinhasAvaliacoes() {
  const container = document.getElementById("listaAvaliacoesSalvas");
  container.innerHTML = '';

  if (avaliacoesJurado.length === 0) {
    container.innerHTML = '<p>Voc√™ ainda n√£o realizou nenhuma avalia√ß√£o.</p>';
    return;
  }

  avaliacoesJurado.forEach(av => {
    const div = document.createElement("div");
    div.className = "avaliacao-item";
    div.innerHTML = `
      <div class="avaliacao-info">${av.apresentacao_titulo} (M√©dia: ${av.media})</div>
     <!-- <button class="btn btn-danger" onclick='excluirAvaliacaoPorItem(${av.apresentacao_id})'>üóëÔ∏è Excluir</button>  -->
    `;
    container.appendChild(div);
  });
}

	


<!--
	// Permite excluir pelo item na lista
	
    async function excluirAvaliacaoPorItem(apresentacao_id) {
      if (!confirm("Excluir esta avalia√ß√£o?")) return;
      document.getElementById("videoSelect").value = apresentacao_id;
      await excluirAvaliacao();
    }
	-->
	
	// Fun√ß√µes dos bot√µes
    document.getElementById("btnSalvar").onclick = salvarAvaliacao;
    document.getElementById("btnExcluir").onclick = excluirAvaliacao;




   function sair() {
      if (confirm("Deseja sair?")) {
        localStorage.removeItem("usuarioAtual");
        window.location.href = "index.html";
      }
    }
	
  </script>
  
  <!--<a href="minhas_avaliacoes.html" class="botao botao-centralizado">üëÅÔ∏è Excluir avalia√ß√µes</a>   
  -->
</body>
</html>